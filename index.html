<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>List of customerssssss</title>
    <link href="./assets/bootstrap/v5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/fontawesome/v5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="./assets/sweetalert2/v11.7.12/sweetalert2.all.min.css">
    <link rel="stylesheet" href="./style.css">

</head>

<body>
    <div class="container">
        <header>
            <div class="col-lg-6">
                <h1>List of customers</h1>
            </div>
            <div class="col-lg-6 header-right-button">
                <a href="#">
                    <button class="btn btn-outline-light">
                        <i class="fas fa-history"></i>
                        Transfer histories
                    </button>
                </a>
                <button class="btn btn-outline-light" id="btnShowModalCreate">
                    <i class="fas fa-user-plus"></i>
                    Add new customer
                </button>
            </div>
        </header>

        <div class="content">
            <table class="table table-hover" id="tbCustomer">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Full name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Address</th>
                        <th>Balance</th>
                        <th colspan="3">Action</th>
                    </tr>
                </thead>
                <tbody>
                   
                </tbody>
            </table>
        </div>
    </div>


    <!-- Modal Create -->
    <div class="modal fade" id="modalCreate" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Modal create</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label class="fw-bold">Full Name</label>
                                <input type="text" class="form-control" id="fullNameCre">
                            </div>
                            <div class="col-lg-6">
                                <label class="fw-bold">Email</label>
                                <input type="email" class="form-control" id="emailCre">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label class="fw-bold">Phone</label>
                                <input type="tel" class="form-control" id="phoneCre">
                            </div>
                            <div class="col-lg-6">
                                <label class="fw-bold">Address</label>
                                <input type="text" class="form-control" id="addressCre">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="btnCreate">
                        <i class="fas fa-plus"></i>
                        Save changes
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal Update -->
    <div class="modal fade" id="modalUpdate" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Modal update</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label class="fw-bold">Full Name</label>
                                <input type="text" class="form-control" id="fullNameUp">
                            </div>
                            <div class="col-lg-6">
                                <label class="fw-bold">Email</label>
                                <input type="email" class="form-control" id="emailUp">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label class="fw-bold">Phone</label>
                                <input type="tel" class="form-control" id="phoneUp">
                            </div>
                            <div class="col-lg-6">
                                <label class="fw-bold">Address</label>
                                <input type="text" class="form-control" id="addressUp">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="btnUpdate">
                        <i class="fas fa-pencil-alt"></i>
                        Save changes
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal Deposit -->
    <div class="modal fade" id="modalDeposit" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Modal deposit</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <div class="row mb-3">
                            
                            <div class="col-lg-6">
                                <label class="fw-bold">Full Name</label>
                                <input type="text" class="form-control" id="fullNameDeposit" readonly>
                            </div>
                        
                        <div class="col-lg-6">
                            <label class="fw-bold">Email</label>
                            <input type="text" class="form-control" id="emailDeposit" readonly>
                        </div>
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label class="fw-bold">Current balance ($)</label>
                                <input type="text" class="form-control num-space" id="balanceDeposit" readonly>
                            </div>
                            <div class="col-lg-6">
                                <label class="fw-bold">Transaction Amount ($)</label>
                                <input type="text" class="form-control num-space" name="transactionAmountDeposit"
                                    id="transactionAmountDeposit">
                            </div>
                        </div>
                    </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="btnDeposit">
                        <i class="fas fa-plus"></i>
                        Deposit
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal Withdraw -->
    <div class="modal fade" id="modalWithdraw" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Modal withdraw</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <div class="row mb-3">
                            
                            <div class="col-lg-6">
                                <label class="fw-bold">Full Name</label>
                                <input type="text" class="form-control" id="fullNameWithdraw" readonly>
                            </div>
                            <div class="col-lg-6">
                                <label class="fw-bold">Email</label>
                                <input type="email" class="form-control" id="emailWithdraw" readonly>
                            </div>
                        </div>
                       
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label class="fw-bold">Current balance ($)</label>
                                <input type="text" class="form-control num-space" id="balanceWithdraw" readonly>
                            </div>
                            <div class="col-lg-6">
                                <label class="fw-bold">Transaction Amount ($)</label>
                                <input type="text" class="form-control num-space" name="transactionAmount"
                                    id="transactionAmountWithdraw">
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-warning" id="btnWithdraw">
                        <i class="fa fa-minus" aria-hidden="true"></i>
                        Withdraw
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Transfer -->
    <div class="modal fade" id="modalTransfer" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Modal transfer</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <div class="row mb-3">
                            <div class="col-lg-3">
                                <label class="fw-bold">Sender ID</label>
                                <input type="number" class="form-control" id="senderId" readonly>
                            </div>
                            <div class="col-lg-3">
                                <label class="fw-bold">Sender Name</label>
                                <input type="text" class="form-control" id="senderFullName" readonly>
                            </div>
                            <div class="col-lg-3">
                                <label class="fw-bold">Email </label>
                                <input type="email" class="form-control" id="senderEmail" required>
                            </div>
                            <div class="col-lg-3">
                                <label class="fw-bold">Sender balance ($)</label>
                                <input type="tel" class="form-control" id="senderBalance" readonly>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-lg-3">
                                <label class="fw-bold" id="recipientId">Recipient Name</label>

                            </div>
                            <div class="col-lg-3">
                                <label class="fw-bold">Transfer amount</label>
                                <input type="text" name="transferAmount" class="form-control" id="transferAmount"
                                    oninput="handleTotalAmountTransaction(this)">
                            </div>
                            <div class="col-lg-3">
                                <label class="fw-bold">Fees (%)</label>
                                <input type="tel" name="fees" id="fees" class="form-control" id="feees" readonly>
                            </div>
                            <div class="col-lg-3">
                                <label class="fw-bold">Total amount of transaction ($)</label>
                                <input type="tel" name="transactionAmount" id="transactionAmount" class="form-control"
                                    readonly>
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-outline-primary" id="btnTransfer">
                        <i class="fas fa-exchange-alt"></i>
                        Transfer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="./assets/js/jquery-3.6.0.min.js"></script>
    <script src="./assets/bootstrap/v5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/sweetalert2/v11.7.12/sweetalert2.all.min.js"></script>
<!-- 
    <script>
        function handleTotalAmountTransaction(element) {
            let transferAmount = Number(element.value);
            let fees = Number(document.getElementById("fees").value);
            let feesAmount = fees * transferAmount * 0.01;
            document.getElementById("transactionAmount").value = transferAmount + feesAmount;
        }
    </script> -->
    <script>

        let maxId = 1;
        let customerId = 0;

        function renderCustomer(customer) {
            return `
                <tr id="tr_${customer.id}">
                    <td class="text-center">${customer.id}</td>
                    <td>${customer.fullName}</td>
                    <td class="text-center">${customer.email}</td>
                    <td class="text-center">${customer.phone}</td>
                    <td>${customer.address}</td>
                    <td>${customer.balance}</td>
                    
                    <td class="text-end num-space"></td>
                    <td>
                        <button class="btn btn-outline-secondary edit" data-id="${customer.id}">
                            <i class="fas fa-pencil-alt"></i>
                        </button>

                        <button class="btn btn-outline-success deposit" data-id="${customer.id}">
                            <i class="fa fa-plus"></i>
                        </button>

                        <button class="btn btn-outline-warning withdraw" data-id="${customer.id}">
                            <i class="fa fa-minus"></i>
                        </button>

                        <button class="btn btn-outline-primary transfer" data-id="${customer.id}">
                            <i class="fas fa-exchange-alt"></i>
                        </button>

                        <button class="btn btn-outline-danger delete" data-id="${customer.id}">
                            <i class="fas fa-ban"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        function getAllCustomers() {
            const tbCustomerBody = $('#tbCustomer tbody');
            tbCustomerBody.empty();
            $.ajax({
                    type: 'GET',
                    url: 'http://localhost:3000/customers'
                })
                .done((data) => {
                    data.forEach(item => {
                        const str = renderCustomer(item);
                        tbCustomerBody.prepend(str);
                        addAllRender();
                   
                    });
                })
                .fail((error) => {
                    console.log(error);
                })
        }
        getAllCustomers();
        addAllRender();

        function addAllRender(){
            handleAddEventShowModalUpdate();
            handleAddEventShowModalDeposit();
            handleAddEventShowModalWithdraw();
        }

        const btnShowModalCreate = $('#btnShowModalCreate');
        btnShowModalCreate.on('click', () => {
            $('#modalCreate').modal('show');
        })

        const btnCreate = $('#btnCreate');
        btnCreate.on('click', function () {
            const fullName = $('#fullNameCre').val();
            const email = $('#emailCre').val();
            const phone = $('#phoneCre').val();
            const address = $('#addressCre').val();
            const balance = 0;
            const deleted = 0;

            const customer = {
                fullName,
                email,
                phone,
                address,
                balance,
                deleted
            }


            $.ajax({
                    headers: {
                        'accept': 'application/json',
                        'content-type': 'application/json'
                    },
                    type: 'POST',
                    url: 'http://localhost:3000/customers',
                    data: JSON.stringify(customer)
                })
                .done((data) => {
                    const str = renderCustomer(data);
                    const tbCustomerBody = $('#tbCustomer tbody');
                    tbCustomerBody.prepend(str);
                    $('#modalCreate').modal('hide');

                    Swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title: 'Thêm thành công',
                    showConfirmButton: false,
                    timer: 1500
                    })
                })
                .fail((error) => {
                    console.log(error);
                })
        })

        function getCustomerById(id) {
            return $.ajax({
                type:'GET',
                url:'http://localhost:3000/customers/' + id,
            })
           
        }

        function findCustomerIndexById(id) {
            let index = -1;

            for (let i = 0; i < customers.length; i++) {
                if (customers[i].id === id) {
                    index = i;
                }
            }
            return index;
        }
        //-----------------------Update

        function handleAddEventShowModalUpdate() {
            let btnEdit = $('.edit');
            btnEdit.off('click');
            btnEdit.on('click', function () {
                customerId = $(this).data('id');
                const modalUpdate = $('#modalUpdate');
                getCustomerById(customerId).then((data) => {
                $('#fullNameUp').val(data.fullName);
                $('#emailUp').val(data.email);
                $('#phoneUp').val(data.phone);
                $('#addressUp').val(data.address);
                modalUpdate.modal('show');
                })
                .catch((error) => {
                        console.log(error);
                    });
            })
            // getAllCustomers();
        }

        
        function update(customer) {
            $.ajax({
                headers: {
                        'accept': 'application/json',
                        'content-type': 'application/json'
                    },
                    type: 'PATCH',
                    url: 'http://localhost:3000/customers/'+ customerId,
                    data: JSON.stringify(customer)
                })
                .done((data) => {
                    const str = renderCustomer(data);
                    const currentRow = $('#tr_' + customerId);
                    currentRow.replaceWith(str);

                    addAllRender();
                    $('#modalUpdate').modal('hide'); 
                    Swal.fire({
                    position: 'top-end',
                    icon: 'success',
                    title: 'Cập nhật thành công',
                    showConfirmButton: false,
                    timer: 1500
                    })    
                })
                .fail((error) => {
                    console.log(error);
                })
        }
        
        const btnUpdate = $('#btnUpdate');
        btnUpdate.on('click', () => {
            const fullName = $('#fullNameUp').val();
            const email = $('#emailUp').val();
            const phone = $('#phoneUp').val();
            const address = $('#addressUp').val();

            const customer = {
                fullName,
                email,
                phone,
                address
            }
            update(customer);
        })

        //----------------------------- Show deposit
        function handleAddEventShowModalDeposit() {
            let btnDeposit = $('.deposit');

            console.log(btnDeposit);
            console.log("deposit");

            btnDeposit.on('click', function () {
                customerId = $(this).data('id');

                const modalDeposit = $('#modalDeposit');

                getCustomerById(customerId).then((data) => {
                    customer = data;
                    $('#fullNameDeposit').val(customer.fullName);
                    $('#emailDeposit').val(customer.email);
                    $('#balanceDeposit').val(customer.balance);

                    modalDeposit.modal('show');
                })
                    .catch((error) => {
                        console.log(error);
                    });
            })
        }
        const btnDeposit = $('#btnDeposit');
        btnDeposit.on('click', () => {
            const currentBalance = customer.balance;
            const transactionAmount = +$('#transactionAmountDeposit').val();
            const newBalance = currentBalance + transactionAmount;
            customer.balance = newBalance;

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'PATCH',
                url: 'http://localhost:3000/customers/' + customerId,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    const str = renderCustomer(data);
                    const currentRow = $('#tr_' + customerId);
                    currentRow.replaceWith(str);
                    addAllRender();
                    $('#modalDeposit').modal('hide');

                    Swal.fire({
                        position: 'top-end',
                        icon: 'success',
                        title: 'Nạp tiền thành công',
                        showConfirmButton: false,
                        timer: 1500
                    })
                })
                .fail((error) => {
                    console.log(error);
                })


            const obj = {
                customerId,
                transactionAmount
            }

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: 'http://localhost:3000/deposits',
                data: JSON.stringify(obj)
            })
                .done((data) => {

                })
                .fail((error) => {
                    console.log(error);
                })
        })

        //----------------------------- Show withdraw
        function handleAddEventShowModalWithdraw() {
            let btnWithdraw = $('.withdraw');
            btnWithdraw.on('click', function () {
                customerId = $(this).data('id');
                const modalWithdraw = $('#modalWithdraw');

                getCustomerById(customerId).then((data) => {
                    customer = data;
                    $('#fullNameWithdraw').val(customer.fullName);
                    $('#emailWithdraw').val(customer.email);
                    $('#balanceWithdraw').val(customer.balance);
                    modalWithdraw.modal('show');
                })
                    .catch((error) => {
                        console.log(error);
                    });
            })
        }
        const btnWithdraw = $('#btnWithdraw');
        btnWithdraw.on('click', function() {
            const currentBalance = customer.balance;
            const transactionAmount = +$('#transactionAmountWithdraw').val();
            const newBalance = currentBalance - transactionAmount;
            customer.balance = newBalance;

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'PATCH',
                url: 'http://localhost:3000/customers/' + customerId,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    const str = renderCustomer(data);
                    const currentRow = $('#tr_' + customerId);
                    currentRow.replaceWith(str);
                    addAllRender();

                    $('#modalWithdraw').modal('hide');

                    Swal.fire({
                        position: 'top-end',
                        icon: 'success',
                        title: 'Rút tiền thành công',
                        showConfirmButton: false,
                        timer: 1500
                    })
                })
                .fail((error) => {
                    console.log(error);
                })
            const obj = {
                customerId,
                transactionAmount
            }

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: 'http://localhost:3000/withdraws',
                data: JSON.stringify(obj)
            })
                .done((data) => {

                })
                .fail((error) => {
                    console.log(error);
                })
        })

        // function handleAddEventDeleteCustomer() {

        //     const btnDelete = document.querySelectorAll(".delete");
        //     btnDelete.forEach((item) => {
        //         item.addEventListener("click", function () {
        //             customerId = +item.getAttribute("data-id");
        //             let cf = confirm("Bạn chắc chắn muốn xoá?");
        //             if (cf) {
        //                 for (var i = 0; i < customers.length; i++) {
        //                     if (customers[i].id === customerId) {
        //                         customers.splice(i, 1);
        //                     }
        //                 }
        //             }
        //             getAllCustomers();

        //         });
        //     });
        // }

        //---------------------show tranfer
        function addEventShowModalTransfer() {
            const btnTransfer = document.querySelectorAll(".transfer");
            btnTransfer.forEach((item) => {
                item.addEventListener("click", function () {
                    customerId = +item.getAttribute("data-id");
                    var sender = getCustomerById(customerId);

                    document.getElementById("senderId").value = sender.id;
                    document.getElementById("senderFullName").value = sender.fullName;
                    document.getElementById("senderEmail").value = sender.email;
                    document.getElementById("senderBalance").value = sender.balance;

                    const select = document.getElementById("recipientId");
                    select.innerHTML = "";
                    customers.forEach((customer) => {
                        if (customer.id != sender.id) {
                            const option = document.createElement("option");
                            option.value = customer.id;
                            option.text = "(" + customer.id + ")" + " " + customer.fullName;
                            select.appendChild(option);
                        }
                    });
                    const modalTransfer = new bootstrap.Modal(document.getElementById(
                    'modalTransfer'), {
                        keyboard: false
                    })
                    modalTransfer.show()
                })
            })
        }
        addEventShowModalTransfer();

        function handleTransfer() {
            const btnTransfer = document.getElementById('btnTransfer')
            btnTransfer.addEventListener("click", function () {
                var sender = getCustomerById(customerId);
                console.log("sender " + sender);
                var recipientId = +document.getElementById("recipientId").value;
                var recipient = getCustomerById(recipientId);
                console.log("recipient " + recipient);

                if (sender.id === recipient.id) {
                    document.getElementById("transfer-name-error").innerText = "Người nhận không hợp lệ";
                } else {
                    var transferAmount = +document.getElementById("transferAmount").value;
                    var fees = 0.1;

                    if (!isNaN(transferAmount)) {
                        if (transferAmount <= 0) {
                            document.getElementById("transfer-error").innerText = "Số tiền phải > 0";
                        } else {
                            var feesAmount = parseFloat(transferAmount * fees);
                            var transactionAmount = transferAmount + feesAmount;

                            if (transactionAmount > 500000000) {
                                document.getElementById("transfer-error").innerText =
                                    "Số tiền giao dịch tối đa 500.000.000";
                            } else {
                                if (transactionAmount > sender.balance) {
                                    document.getElementById("transfer-error").innerText =
                                        "Số dư không đủ để thực hiện giao dịch";
                                } else {
                                    var newBalance = sender.balance - transactionAmount;

                                    sender.setBalance(newBalance);
                                    recipient.setBalance(recipient.balance + transferAmount);

                                    document.getElementById("senderBalance").value = newBalance;
                                    document.getElementById("transfer-error").innerText = "";
                                    document.getElementById("transfer-name-error").innerText = "";
                                }

                            }
                        }

                    } else {
                        document.getElementById("transfer-error").innerText = "Không được nhập chữ";
                    }
                }

                getAllCustomers();
                addEventShowModalTransfer();
            })
        }

        handleTransfer()
    </script>
</body>

</html>